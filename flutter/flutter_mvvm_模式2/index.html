<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">

    
<link rel="stylesheet" href="/blog-theme/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/blog-theme/css/global.css">

    
<link rel="stylesheet" href="/blog-theme/css/article.css">

    
    
<script src="/blog-theme/bootstrap/js/bootstrap.bundle.min.js"></script>


    <title>
        I&#39;m prime
    </title>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="bg-dark">
    <header>
    <nav class="navbar navbar-expand navbar-expand-lg navbar-dark sticky-top shadow">
        <div class="container-fluid">
            <a class="navbar-brand" href="/blog-theme/">

                

            I&#39;m prime
            </a>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
                <ul class="navbar-nav">

                    

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page"
                                href="/blog-theme/">
                                主页
                            </a>
                        </li>

                    

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page"
                                href="/blog-theme/archives/">
                                归档
                            </a>
                        </li>

                    

                </ul>
            </div>
        </div>
    </nav>
</header>
    <div class="container-fluid mt-md-5">
    <div class="row">
        <div class="col"></div>
        <div class="col-12 col-sm-10 col-md-8 col-lg-7 col-xl-5 shadow-lg">
            <div class="container-fluid mt-5 text-center">
                <h1 class="text-white">
                    flutter mvvm 模式 2020.01
                </h1>
                <p class="mt-2 text-secondary">
                    2020.01.16
                </p>
            </div>

            <article class="container-fluid text-white">
                <h2 id="λ："><a href="#λ：" class="headerlink" title="λ："></a>λ：</h2><p>这篇文章是对 “ <a href="https://lzyprime.github.io/flutter/flutter_mvvm_%E6%A8%A1%E5%BC%8F.html"><em><strong>19年11月的文章</strong></em></a> ”的补充， 就文章里用到的 <code>rxdart ^0.22.2</code> 与最新版本 <code>rxdart ^0.23.1</code> 出现了大改动，以至于原文中的代码在最新插件下不可用。。。</p>
<p>这次插件更新， 相当于给原生 <code>Stream</code> 类添加了一组拓展方法，而不是像以前一样用 <code>Observable</code> 类再包一层达到效果。（<a target="_blank" rel="noopener" href="https://pub.dev/packages/rxdart#-changelog-tab-">详情rxdart的更新日志</a>)</p>
<p>也就是说，添加完插件后，你可以在任意<code>Stream</code> 调用一系列方法。如之前demo里用到的<code>doOnData doOnDone doOnListen zipWith</code>。还有更多内容可看<a target="_blank" rel="noopener" href="https://pub.dev/packages/rxdart">官网详情</a></p>
<h2 id="github-仓库-flutter-demos-分支-mvvm-demo"><a href="#github-仓库-flutter-demos-分支-mvvm-demo" class="headerlink" title="github 仓库: flutter_demos 分支 mvvm_demo"></a><a target="_blank" rel="noopener" href="https://github.com/lzyprime/flutter_demos/tree/mvvm_demo">github 仓库: flutter_demos 分支 mvvm_demo</a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b mvvm_demo https://github.com/lzyprime/flutter_demos.git</span><br></pre></td></tr></table></figure>

<h2 id="mvvm"><a href="#mvvm" class="headerlink" title="mvvm"></a>mvvm</h2><p>mvvm 在 <a href="https://lzyprime.github.io/flutter/flutter_mvvm_%E6%A8%A1%E5%BC%8F.html">原文章</a> 大概介绍过，而且架构这种东西无关语言。具体是什么，相信wiki说的比我好。</p>
<h2 id="flutter项目-mvvm"><a href="#flutter项目-mvvm" class="headerlink" title="flutter项目 mvvm"></a>flutter项目 mvvm</h2><h3 id="1-添加插件：provider-4-0-1（rxdart-0-23-1-PS-如果用不到-rxdart-的东西，可以不要这个插件）。-在-pubspec-yaml-文件"><a href="#1-添加插件：provider-4-0-1（rxdart-0-23-1-PS-如果用不到-rxdart-的东西，可以不要这个插件）。-在-pubspec-yaml-文件" class="headerlink" title="1. 添加插件：provider ^4.0.1（rxdart ^0.23.1 PS: 如果用不到 rxdart 的东西，可以不要这个插件）。 在 pubspec.yaml 文件"></a>1. 添加插件：<code>provider ^4.0.1</code>（<code>rxdart ^0.23.1</code> PS: 如果用不到 <code>rxdart</code> 的东西，可以不要这个插件）。 在 <code>pubspec.yaml</code> 文件</h3><p><img src="../flutter_mvvm_%E6%A8%A1%E5%BC%8F2/pubspec.png" alt="pubspec.yaml"></p>
<h3 id="2-view，-构建UI，数据来源于viewModel"><a href="#2-view，-构建UI，数据来源于viewModel" class="headerlink" title="2. view， 构建UI，数据来源于viewModel"></a>2. <code>view</code>， 构建UI，数据来源于<code>viewModel</code></h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file path: package:flutter_mvvm_demo/views/login_widget.dart</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:provider/provider.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_mvvm_demo/viewModels/login_view_model.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginWidget</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> provider = Provider.of&lt;LoginViewModel&gt;(context);</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: Column(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          TextField(</span><br><span class="line">            controller: provider.usernameController,</span><br><span class="line">            decoration: InputDecoration(labelText: <span class="string">&quot;username&quot;</span>),</span><br><span class="line">          ),</span><br><span class="line">          TextField(</span><br><span class="line">            controller: provider.passwordController,</span><br><span class="line">            decoration: InputDecoration(labelText: <span class="string">&quot;password&quot;</span>),</span><br><span class="line">          ),</span><br><span class="line">          RaisedButton(</span><br><span class="line">            onPressed: provider.login,</span><br><span class="line"></span><br><span class="line">            <span class="comment">/// <span class="markdown">根据 state 的值，按钮显示不同内容。</span></span></span><br><span class="line">            child: provider.state == <span class="number">0</span></span><br><span class="line">                ? Text(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">                : provider.state == <span class="number">1</span></span><br><span class="line">                    ? CircularProgressIndicator()</span><br><span class="line">                    : provider.state == <span class="number">2</span></span><br><span class="line">                        ? Icon(Icons.done)</span><br><span class="line">                        : Icon(Icons.cancel),</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-model-请求和处理"><a href="#3-model-请求和处理" class="headerlink" title="3. model, 请求和处理"></a>3. <code>model</code>, 请求和处理</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file path: package:flutter_mvvm_demo/models/login_model.dart</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginModel</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="markdown">直接将网络请求的 Future 对象包装成 Stream 返回</span></span></span><br><span class="line">  <span class="comment">/// <span class="markdown">Stream.fromFuture 等构造方法。更多细节参考官方文档</span></span></span><br><span class="line">  <span class="comment">/// <span class="markdown">因为是 demo 所以用 Future.delayed 模拟请求过程</span></span></span><br><span class="line">   Stream&lt;<span class="built_in">int</span>&gt; login(<span class="built_in">dynamic</span> data) =&gt; Stream.fromFuture(</span><br><span class="line">     Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">2</span>), () &#123;</span><br><span class="line">          <span class="keyword">if</span> (data[<span class="string">&quot;username&quot;</span>] == <span class="string">&quot;lzyprime&quot;</span> &amp;&amp; data[<span class="string">&quot;password&quot;</span>] == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;),</span><br><span class="line">   );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-viewModel"><a href="#4-viewModel" class="headerlink" title="4. viewModel"></a>4. <code>viewModel</code></h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file path: package:flutter_mvvm_demo/view_models/login_view_model.dart</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="comment">// import &#x27;package:rxdart/rxdart.dart&#x27;; 如果需要，自行添加插件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_mvvm_demo/models/login_model.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="markdown">with ChangeNotifier : 通过 notifyListeners() 函数，可以通知本对象数据的正在使用者们。</span></span></span><br><span class="line"><span class="comment">/// <span class="markdown">如 state 变量，在改变后调用 notifyListeners(), UI根据值重新构建登录按钮显示内容</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginViewModel</span> <span class="title">with</span> <span class="title">ChangeNotifier</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _model = LoginModel();</span><br><span class="line">  <span class="built_in">int</span> state = <span class="number">0</span>; <span class="comment">// 0 未请求，1 正在请求， 2 请求成功， 3请求失败</span></span><br><span class="line">  <span class="keyword">final</span> usernameController = TextEditingController();</span><br><span class="line">  <span class="keyword">final</span> passwordController = TextEditingController();</span><br><span class="line"></span><br><span class="line">  login() &#123;</span><br><span class="line">    <span class="keyword">final</span> data = &#123;</span><br><span class="line">      <span class="string">&quot;username&quot;</span>: usernameController.text,</span><br><span class="line">      <span class="string">&quot;password&quot;</span>: passwordController.text,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// <span class="markdown">不为 0 说明上一条请求未完成，直接退出</span></span></span><br><span class="line">    <span class="keyword">if</span> (state != <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// <span class="markdown">开始请求，state 赋值为 1， 并通知监听者</span></span></span><br><span class="line">    <span class="comment">/// <span class="markdown">如果用rxDart插件，可作为doOnListen参数的函数体</span></span></span><br><span class="line">    state = <span class="number">1</span>;</span><br><span class="line">    notifyListeners();</span><br><span class="line"></span><br><span class="line">    _model.login(data)</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// <span class="markdown">rxDart 插件</span></span></span><br><span class="line"><span class="comment">//        .doOnListen(() &#123;</span></span><br><span class="line"><span class="comment">//      state = 1;</span></span><br><span class="line"><span class="comment">//      notifyListeners();</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line">        .listen((v) &#123;</span><br><span class="line">      <span class="keyword">if</span> (v != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/// <span class="markdown">返回值不为0，请求失败</span></span></span><br><span class="line">        state = <span class="number">3</span>;</span><br><span class="line">        notifyListeners();</span><br><span class="line">        Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>), () &#123;</span><br><span class="line">          state = <span class="number">0</span>;</span><br><span class="line">          notifyListeners();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/// <span class="markdown">返回值为0，请求成功</span></span></span><br><span class="line">        state = <span class="number">2</span>;</span><br><span class="line">        notifyListeners();</span><br><span class="line">        Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>), () &#123;</span><br><span class="line">          state = <span class="number">0</span>;</span><br><span class="line">          notifyListeners();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="组装三者"><a href="#组装三者" class="headerlink" title="组装三者"></a>组装三者</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:provider/provider.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_mvvm_demo/views/login_widget.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_mvvm_demo/viewModels/login_view_model.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(MyApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This widget is the root of your application.</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter mvvm Demo&#x27;</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// <span class="markdown">[ChangeNotifierProvider]。所有的viewModel通过 Provider 实现与view 层的绑定。</span></span></span><br><span class="line">      <span class="comment">/// <span class="markdown">Provider 是对 [InheritedWidget] 封装。因此我们才能实现调用notifyListeners() 时，通知子树重新构建</span></span></span><br><span class="line">      <span class="comment">/// <span class="markdown">当然你也可以一个插件也不用，自己封装[InheritedWidget]</span></span></span><br><span class="line">      home: ChangeNotifierProvider(</span><br><span class="line">        create: (_) =&gt; LoginViewModel(),</span><br><span class="line">        child: LoginWidget(),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><ul>
<li><h3 id="state-0，-未请求"><a href="#state-0，-未请求" class="headerlink" title="state == 0， 未请求"></a>state == 0， 未请求</h3><p><img src="../flutter_mvvm_%E6%A8%A1%E5%BC%8F2/state0.png" alt="state0"></p>
</li>
<li><h3 id="state-1-显示加载"><a href="#state-1-显示加载" class="headerlink" title="state == 1, 显示加载"></a>state == 1, 显示加载</h3><p><img src="../flutter_mvvm_%E6%A8%A1%E5%BC%8F2/state1.png" alt="state1"></p>
</li>
<li><h3 id="state-2-请求成功"><a href="#state-2-请求成功" class="headerlink" title="state == 2, 请求成功"></a>state == 2, 请求成功</h3><p><img src="../flutter_mvvm_%E6%A8%A1%E5%BC%8F2/state2.png" alt="state2"></p>
</li>
<li><h3 id="state-3-请求失败"><a href="#state-3-请求失败" class="headerlink" title="state == 3, 请求失败"></a>state == 3, 请求失败</h3><p><img src="../flutter_mvvm_%E6%A8%A1%E5%BC%8F2/state3.png" alt="state2"></p>
</li>
</ul>
<h2 id="～λ："><a href="#～λ：" class="headerlink" title="～λ："></a>～λ：</h2><p>这只是个demo， 主要看三者怎么拆以及怎么拼装，实际请求肯定还要判好多问题。</p>
<p>实际应用时，<code>model</code>组织api请求，而一个页面可能涉及多个模块的请求，因此，一个 <code>viewModel</code> 包含多个 <code>model</code> 类也有可能。但尽量避免这种情况，做好请求分类</p>

            </article>
        </div>

        <div class="col"></div>
    </div>
</div>
    <footer class="h-25"> footer </footer>
</body>

</html>