<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">

    
<link rel="stylesheet" href="/blog-theme/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/blog-theme/css/global.css">

    
<link rel="stylesheet" href="/blog-theme/css/article.css">

    
    
<script src="/blog-theme/bootstrap/js/bootstrap.bundle.min.js"></script>


    <title>
        I&#39;m prime
    </title>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="bg-dark">
    <header>
    <nav class="navbar navbar-expand navbar-expand-lg navbar-dark sticky-top shadow">
        <div class="container-fluid">
            <a class="navbar-brand" href="/blog-theme/">

                

            I&#39;m prime
            </a>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
                <ul class="navbar-nav">

                    

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page"
                                href="/blog-theme/">
                                主页
                            </a>
                        </li>

                    

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page"
                                href="/blog-theme/archives/">
                                归档
                            </a>
                        </li>

                    

                </ul>
            </div>
        </div>
    </nav>
</header>
    <div class="container-fluid mt-md-5">
    <div class="row">
        <div class="col"></div>
        <div class="col-12 col-sm-10 col-md-8 col-lg-7 col-xl-5 shadow-lg">
            <div class="container-fluid mt-5 text-center">
                <h1 class="text-white">
                    Android 底部导航栏+页面切换
                </h1>
                <p class="mt-2 text-secondary">
                    2020.11.25
                </p>
            </div>

            <article class="container-fluid text-white">
                <h2 id="kotlin-amp-android-笔记"><a href="#kotlin-amp-android-笔记" class="headerlink" title="kotlin &amp; android 笔记"></a><a href="https://lzyprime.github.io/kotlin_android/kotlin_android">kotlin &amp; android 笔记</a></h2><hr>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><h3 id="2020-12-21-解决-“在item2页面点击返回键会返回item1-而非退出”-问题"><a href="#2020-12-21-解决-“在item2页面点击返回键会返回item1-而非退出”-问题" class="headerlink" title="2020.12.21 解决 “在item2页面点击返回键会返回item1, 而非退出” 问题"></a>2020.12.21 解决 <em><strong>“在item2页面点击返回键会返回item1, 而非退出”</strong></em> 问题</h3><p>之前笔记里（<a href="https://lzyprime.github.io/kotlin_android/android_navigation">android navigation组件</a>）记录整个导航组件时, 其中关于自定义返回导航只是简单一提， 并用于在<code>MainActivity</code>的回调里整体组织路由。</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/navigation/navigation-custom-back?hl=zh-cn">提供自定义返回导航 官网文档</a></p>
<p>给<code>Item2, Item3</code>页面注册返回事件， <code>addCallBack</code>用<code>(LifecycleOwner, OnBackPressedCallback)</code>版本, 会检测生存期，在页面被销毁时自动删掉回调。<code>OnBackPressedCallback</code> 构造函数传入 <code>Boolean</code> 表示回调初始是否开启（<code>isEnable</code>）, 之后可以调用它的 <code>setEnable</code> 来改变状态。 </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 仓库已经更新</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item2Fragment</span>: <span class="type">Fragment</span></span>(R.layout.item2_fragment)&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        requireActivity().onBackPressedDispatcher.addCallback(<span class="keyword">this</span>, <span class="keyword">object</span> :OnBackPressedCallback(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleOnBackPressed</span><span class="params">()</span></span> &#123;</span><br><span class="line">                requireActivity().finish()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="原文："><a href="#原文：" class="headerlink" title="原文："></a>原文：</h1><h2 id="λ："><a href="#λ：" class="headerlink" title="λ："></a>λ：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># android bottom navigation demo</span></span><br><span class="line"><span class="comment"># 仓库地址: https://github.com/lzyprime/android_demos</span></span><br><span class="line"><span class="comment"># branch: bottom_navigation</span></span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> -b bottom_navigation https://github.com/lzyprime/android_demos</span><br></pre></td></tr></table></figure>

<p>底部导航配合多页面切换是常见逻辑，微信，qq，抖音，淘宝等等，常见app里几乎都有这种设计。</p>
<p>底部导航栏涉及到图标和标题在点击时的变化（颜色，大小，选中与未选中图标变化）</p>
<p>而上方的页面切换有两个常用方案：</p>
<ol>
<li><p>用之前说过的 <strong><a href="https://lzyprime.github.io/kotlin_android/android_navigation">navigation组件</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/navigation/navigation-swipe-view-2">ViewPager2</a></strong></p>
</li>
</ol>
<p>参考 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/navigation/navigation-ui">使用 NavigationUI 更新界面组件</a>。 会发现用<code>navigation组件</code>实现这套东西时可以一行代码搞定。甚至在 <em><code>创建新Android Activity</code></em> 时提供了生成版本：</p>
<p><img src="../android_bottom_navigation/1.png"></p>
<p>这本身就可以当个demo。包含了底部栏如何配置，NavHost怎么设置。而且其中的Fragment还有<code>ViewModel</code>。</p>
<p>但有一个问题就是每次切换页面，Fragment都是重新构建的，就算数据可以在<code>ViewModel</code>活着，但是其他状态还是需要自己维护，比如列表滑动位置。</p>
<p>所以改用<code>ViewPager2</code>， 通过设置<code>offscreenPageLimit</code>来缓存页面。<code>ViewPager2</code>底层是<code>RecyclerView</code>, 用来替代之前的<code>ViewPager</code>, 尽力保持两版接口一致，同时解决之前遗留的很多棘手问题。</p>
<h2 id="1-底部导航栏：BottomNavigationView"><a href="#1-底部导航栏：BottomNavigationView" class="headerlink" title="1. 底部导航栏：BottomNavigationView"></a>1. 底部导航栏：<code>BottomNavigationView</code></h2><ul>
<li>创建新的<code>android Resource file</code>, 类型选择<code>menu</code>。 添加<code>menuItem</code></li>
</ul>
<p><img src="../android_bottom_navigation/2.png"></p>
<ul>
<li>在<code>activity_main.xml</code>添加<code>BottomNavigationView</code>控件，同时设置<code>menu</code>参数，之前设置的<code>menuItem</code>标题和图标会在底部栏直接显示。同时可以通过底部栏的<code>itemIconTint</code>等参数，设置选中态与未选中态的区别</li>
</ul>
<p><img src="../android_bottom_navigation/3.png"></p>
<h2 id="2-页面切换："><a href="#2-页面切换：" class="headerlink" title="2. 页面切换："></a>2. 页面切换：</h2><h3 id="方案1-navigation"><a href="#方案1-navigation" class="headerlink" title="方案1: navigation"></a>方案1: <code>navigation</code></h3><ul>
<li><p>添加 <code>NavHost</code>。如 <a href="https://lzyprime.github.io/kotlin_android/android_navigation">navigation组件</a> 中方式，添加导航图与目的地。</p>
</li>
<li><p><strong>注意<code>id</code>与<code>menu</code>中相同，<code>navController</code>通过<code>id</code>将导航图与底部栏链接</strong></p>
</li>
</ul>
<p><img src="../android_bottom_navigation/4.png"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MainActivity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> navHostFragment = supportFragmentManager.findFragmentById(R.id.mainNavHost) <span class="keyword">as</span> NavHostFragment</span><br><span class="line">        mainBtmNavView.setupWithNavController(navHostFragment.findNavController())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击底部栏便可以切换页面。</p>
<h3 id="方案2-ViewPager2"><a href="#方案2-ViewPager2" class="headerlink" title="方案2: ViewPager2"></a>方案2: <code>ViewPager2</code></h3><p>点击第一页按钮，跳转新的<code>Activity</code>，将页面上方替换为<code>ViewPager2</code>, 其他不变。</p>
<ul>
<li><code>ViewPager2</code> 设置 <code>adapter</code>, 负责页面切换和组织(<code>FragmentStateAdapter</code>)。</li>
<li><code>ViewPager2</code> 设置 <code>offscreenPageLimit</code>， 起到缓存作用</li>
<li><code>ViewPager2</code> 注册 <code>OnPageChangeCallback</code>，页面滑动切换时回调，相当于<code>ViewPager</code>中<code>OnPageChangeListener</code>。 页面切换完成时，设置底部导航栏对应切换。</li>
<li>如果不想滑动切换页面, 设置 <code>ViewPager2</code> 的 <code>isUserInputEnabled = false</code>, 不必注册回调</li>
<li>底部导航栏设置点击事件，<code>ViewPager2</code>跳转对应页面。</li>
</ul>
<p>打印log验证页面是否保活。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecondaryActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> fragments = arrayOf(Item1Fragment(), Item2Fragment(), Item3Fragment())</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> itemIds = arrayOf(R.id.item1, R.id.item2, R.id.item3)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_secondary)</span><br><span class="line"></span><br><span class="line">        secondaryVP.adapter = <span class="keyword">object</span> : FragmentStateAdapter(supportFragmentManager, lifecycle) &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemCount</span><span class="params">()</span></span>: <span class="built_in">Int</span> = fragments.size</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">createFragment</span><span class="params">(position: <span class="type">Int</span>)</span></span>: Fragment = fragments[position]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 页面预加载</span></span><br><span class="line">        secondaryVP.offscreenPageLimit = fragments.size</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若不想滑动切换页面时设置</span></span><br><span class="line">        <span class="comment">//secondaryVP.isUserInputEnabled = false</span></span><br><span class="line">        secondaryVP.registerOnPageChangeCallback(<span class="keyword">object</span> : ViewPager2.OnPageChangeCallback() &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPageSelected</span><span class="params">(position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">                secondaryBtmNavView.selectedItemId = itemIds[position]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        secondaryBtmNavView.setOnNavigationItemSelectedListener &#123;</span><br><span class="line">            secondaryVP.currentItem = itemIds.indexOf(it.itemId)</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            </article>
        </div>

        <div class="col"></div>
    </div>
</div>
    <footer class="h-25"> footer </footer>
</body>

</html>