<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">

    
<link rel="stylesheet" href="/blog-theme/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/blog-theme/css/global.css">

    
<link rel="stylesheet" href="/blog-theme/css/article.css">

    
    
<script src="/blog-theme/bootstrap/js/bootstrap.bundle.min.js"></script>


    <title>
        I&#39;m prime
    </title>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="bg-dark">
    <header>
    <nav class="navbar navbar-expand navbar-expand-lg navbar-dark sticky-top shadow">
        <div class="container-fluid">
            <a class="navbar-brand" href="/blog-theme/">

                

            I&#39;m prime
            </a>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
                <ul class="navbar-nav">

                    

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page"
                                href="/blog-theme/">
                                主页
                            </a>
                        </li>

                    

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page"
                                href="/blog-theme/archives/">
                                归档
                            </a>
                        </li>

                    

                </ul>
            </div>
        </div>
    </nav>
</header>
    <div class="container-fluid mt-md-5">
    <div class="row">
        <div class="col"></div>
        <div class="col-12 col-sm-10 col-md-8 col-lg-7 col-xl-5 shadow-lg">
            <div class="container-fluid mt-5 text-center">
                <h1 class="text-white">
                    Android Skia图形库
                </h1>
                <p class="mt-2 text-secondary">
                    2020.12.17
                </p>
            </div>

            <article class="container-fluid text-white">
                <h2 id="kotlin-amp-android-笔记"><a href="#kotlin-amp-android-笔记" class="headerlink" title="kotlin &amp; android 笔记"></a><a href="https://lzyprime.github.io/kotlin_android/kotlin_android">kotlin &amp; android 笔记</a></h2><hr>
<h2 id="λ："><a href="#λ：" class="headerlink" title="λ："></a>λ：</h2><p><code>Skia</code> 是<code>Android</code>、<code>flutter</code>底层的2D图形库。<a target="_blank" rel="noopener" href="https://skia.org/index_zh">Skia 官网</a>。</p>
<p>2D页面无非就是 <strong>图形(点、线、面)，文字</strong>, 所以<code>Skia</code>设计也很简单：</p>
<ol>
<li>新建<code>Canvas</code>, 画布，所有内容画在这上面</li>
<li>通过<code>Canvas</code>相关方法画出内容。一般名为<code>drawxxx()</code>, 同时要传入一个<code>Paint</code>, 也就是画笔样式。</li>
<li>通过<code>Canvas</code>相关方法裁剪画布，一般名为<code>clipxxx()</code></li>
<li>内容定位，以<code>Canvas</code>左上角为(0, 0)点，向右向下建立(x, y)坐标系。</li>
</ol>
<p>在官网可以直接体验这些API的C++版本，<code>android</code>和<code>flutter</code>无非是做一层包装，API大差不差。</p>
<p>用处：</p>
<ol>
<li><p>自定义View。 不管是<code>Android</code>还是<code>flutter</code>想要自定义程度高就离不开直接操作<code>Render层</code>。大多数情况的确可以用现有的组件拼凑出想要的效果，但坏处就是损失很多没必要的计算和渲染，而且有些东西生写不出来。<code>flutter</code>有很多组件原生设计简单，然后留出<code>canvas</code>用来自定义样式。</p>
</li>
<li><p>设计UI时，大概估计一下有多费。尤其是<code>flutter</code>, 之前团队项目写出来的列表肉眼可见的掉帧。 我翻看这部分代码，发现大量的无用的组件嵌套，然后频繁的<code>rebuild</code>, 宽高很多写死，没有自适应能力。很多UI长一样却不复用，出现<code>ItemXXXView1, ItemXXXView2</code>这种东西。所以有一段时间的工作就是删代码，<code>git</code>记录我一个月添加了几百行然后删了几千行。</p>
</li>
</ol>
<h2 id="Canvas"><a href="#Canvas" class="headerlink" title="Canvas"></a>Canvas</h2><p><a target="_blank" rel="noopener" href="https://skia.org/user/api/skcanvas_overview">官网Canvas介绍</a></p>
<h3 id="draw"><a href="#draw" class="headerlink" title="draw"></a>draw</h3><ol>
<li><code>drawColor</code>: 喷色，不需要传画笔。</li>
<li><code>drawRect</code>: 画矩形<code>Rect</code>，需要左上角点的坐标和矩形宽高，同时传入一个<code>Paint</code>画笔样式</li>
<li><code>drawRoundRect</code>: 类似<code>drawRect</code>, 不同是可以设置圆角，通过传入圆角的 x, y 偏移值</li>
<li><code>drawOval</code>: 椭圆<code>Oval</code>，类似<code>drawRect</code>。</li>
<li><code>drawCicle</code>: 圆<code>Circle</code>, 类似<code>drawRect</code>。</li>
<li><code>drawPath</code>: 画线，需要传入<code>Path</code>线的路径和<code>Paint</code>画笔。</li>
<li><code>drawText</code>: 渲染文字，需要传入文字，起始位置的坐标，<code>Paint</code>画笔（主要设置文字样式）。</li>
</ol>
<h3 id="clip"><a href="#clip" class="headerlink" title="clip"></a>clip</h3><p><code>clipxxx</code>: 裁剪画布，可以传 <code>Path</code>, <code>Oval</code>, <code>Rect</code>, <code>Circle</code> 等等</p>
<h3 id="trans"><a href="#trans" class="headerlink" title="trans"></a>trans</h3><ol>
<li><code>translate(x, y)</code>: 平移到x, y。 作为新的原点</li>
<li><code>scale(x, y)</code>: 缩放</li>
<li><code>rotate</code>: 旋转</li>
<li><code>save</code>: 保存当前状态，一般在变换前调用</li>
<li><code>restore</code>: 恢复现场，必须保证之前有<code>save</code>操作</li>
</ol>
<h2 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h2><p><a target="_blank" rel="noopener" href="https://skia.org/user/api/SkPath_Overview">官网Path介绍</a></p>
<p>除了规则图形外，其他 <em><strong>点，线，面</strong></em> 都可以通过<code>Path</code>画出来。然后就变成了数学题。</p>
<p><em><strong>点动成线，线动成面，面动成体</strong></em>, 当直线长度与画笔粗细相同，就相当于画了一个 <em><strong>点</strong></em>, 而 <em><strong>面</strong></em> 可以看作多根 <em><strong>线</strong></em> 并排的结果。</p>
<ol>
<li><code>moveTo(x, y)</code>: 移动到指定坐标</li>
<li><code>lineTo(x, y)</code>: 从当前位置向 (x, y) 画直线。 获得线段<code>(localX, localY) -&gt; (x, y)</code></li>
<li><code>quadTo(x1, y1, x2, y2)</code>: 贝塞尔曲线。从当前位置经过 (x1, y1) 向 (x2, y2) 画平滑曲线</li>
<li><code>conicTo</code>: 类似<code>quadTo</code></li>
<li><code>addCircle</code>、 <code>addRect</code>等等，添加现成图形</li>
<li><code>close</code>: 当前点与起始点连接，形成闭合图形。</li>
</ol>
<h2 id="Paint"><a href="#Paint" class="headerlink" title="Paint"></a>Paint</h2><p><a target="_blank" rel="noopener" href="https://skia.org/user/api/skpaint_overview">官网Paint介绍</a></p>
<ol>
<li><code>color</code>, <code>width</code>: 颜色，粗细</li>
<li><code>style</code>: 填充方式<ul>
<li><code>fill</code>: 实心</li>
<li><code>stroke</code>: 镂空、描边</li>
</ul>
</li>
<li><code>fontStyle</code>: 字号，字体，字宽，字重等等属性。 原生<code>C++</code>里通过构造<code>可绘制字符串(sk_sp&lt;SkTextBlob&gt;)</code>实现, <code>android</code> 封装进了<code>Paint</code>里。 <code>flutter</code> 封装进了 <code>TextStyle</code>。</li>
<li><code>filter|shader</code>: colorFilter，maskFilter等等效果</li>
</ol>
<h2 id="BlendMode"><a href="#BlendMode" class="headerlink" title="BlendMode"></a>BlendMode</h2><p><a target="_blank" rel="noopener" href="https://skia.org/user/api/SkBlendMode_Overview">官网BlendMode介绍</a></p>
<p>用于处理两个元素A, B 相交时显示方式。</p>
<p>(A在B上， A在B下， A与B同级) * (交集， 并集， 异或集)。</p>
<p><img src="../android_skia/1.png" alt="1.png"></p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>利用<code>Path</code>画圆角长方形。</p>
<ol>
<li>圆角值 <code>topLeft == bottomRight == 20</code>, <code>topRight == bottomLeft == 40</code></li>
<li>起始位置(20, 20)</li>
<li>宽 200, 高 100</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">(SkCanvas* canvas)</span> </span>&#123;</span><br><span class="line">    SkPaint paint;</span><br><span class="line">    paint.<span class="built_in">setAntiAlias</span>(<span class="literal">true</span>);</span><br><span class="line">    paint.<span class="built_in">setStyle</span>(SkPaint::kStroke_Style);</span><br><span class="line">    paint.<span class="built_in">setStrokeWidth</span>(<span class="number">8</span>);</span><br><span class="line">  </span><br><span class="line">    SkPath path;</span><br><span class="line">  	<span class="keyword">double</span> startX = <span class="number">20</span>, startY = <span class="number">20</span>; <span class="comment">// (startX, startY) 左上角</span></span><br><span class="line">  	<span class="keyword">double</span> endX = startX + <span class="number">200</span>, endY = startY + <span class="number">100</span>; <span class="comment">// (endX, endY) 右下角</span></span><br><span class="line">  	<span class="keyword">double</span> topLeftRadius = <span class="number">20</span>, topRightRadius = <span class="number">40</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 移动起始点到左上角，并空出左上角圆角位置。 所以x坐标要+topLeftRadius</span></span><br><span class="line">  	path.<span class="built_in">moveTo</span>(startX + topLeftRadius, startY);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 横向画线，同理空出右上角圆角位置</span></span><br><span class="line">  	path.<span class="built_in">lineTo</span>(endX - topRightRadius, startY);</span><br><span class="line">    <span class="comment">// 右上角的圆角， 经过右上角(endX, startY) 向 (endX, startY + topRightRadius) 画曲线</span></span><br><span class="line">  	path.<span class="built_in">quadTo</span>(endX, startY, endX, startY + topRightRadius);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 同理完成右边, 底边，左边的绘制，最后与起始点 (startX + topLeftRadius, startY) 闭合</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 右边</span></span><br><span class="line">  	path.<span class="built_in">lineTo</span>(endX, endY - topLeftRadius);</span><br><span class="line">    <span class="comment">// 右下圆角</span></span><br><span class="line">  	path.<span class="built_in">quadTo</span>(endX, endY, endX - topLeftRadius, endY);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 底边</span></span><br><span class="line">  	path.<span class="built_in">lineTo</span>(startX + topRightRadius, endY);</span><br><span class="line">    <span class="comment">// 底边圆角</span></span><br><span class="line">  	path.<span class="built_in">quadTo</span>(startX, endY, startX, endY - topRightRadius);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 左边</span></span><br><span class="line">  	path.<span class="built_in">lineTo</span>(startX, startY + topLeftRadius);</span><br><span class="line">    <span class="comment">// 左上圆角</span></span><br><span class="line">  	path.<span class="built_in">quadTo</span>(startX, startY, startX + topLeftRadius, startY);</span><br><span class="line">  </span><br><span class="line">    canvas-&gt;<span class="built_in">drawPath</span>(path, paint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../android_skia/2.png" alt="2.png"></p>

            </article>
        </div>

        <div class="col"></div>
    </div>
</div>
    <footer class="h-25"> footer </footer>
</body>

</html>