<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">

    
<link rel="stylesheet" href="/blog-theme/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/blog-theme/css/global.css">

    
<link rel="stylesheet" href="/blog-theme/css/article.css">

    
    
<script src="/blog-theme/bootstrap/js/bootstrap.bundle.min.js"></script>


    <title>
        I&#39;m prime
    </title>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="bg-dark">
    <header>
    <nav class="navbar navbar-expand navbar-expand-lg navbar-dark sticky-top shadow">
        <div class="container-fluid">
            <a class="navbar-brand" href="/blog-theme/">

                

            I&#39;m prime
            </a>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
                <ul class="navbar-nav">

                    

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page"
                                href="/blog-theme/">
                                主页
                            </a>
                        </li>

                    

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page"
                                href="/blog-theme/archives/">
                                归档
                            </a>
                        </li>

                    

                </ul>
            </div>
        </div>
    </nav>
</header>
    <div class="container-fluid mt-md-5">
    <div class="row">
        <div class="col"></div>
        <div class="col-12 col-sm-10 col-md-8 col-lg-7 col-xl-5 shadow-lg">
            <div class="container-fluid mt-5 text-center">
                <h1 class="text-white">
                    android ViewBinding, DataBinding
                </h1>
                <p class="mt-2 text-secondary">
                    2021.04.23
                </p>
            </div>

            <article class="container-fluid text-white">
                <h2 id="kotlin-amp-android-笔记"><a href="#kotlin-amp-android-笔记" class="headerlink" title="kotlin &amp; android 笔记"></a><a href="https://lzyprime.github.io/kotlin_android/kotlin_android">kotlin &amp; android 笔记</a></h2><hr>
<h2 id="λ："><a href="#λ：" class="headerlink" title="λ："></a>λ：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ViewBinding DataBinding</span></span><br><span class="line"><span class="comment"># 仓库地址: https://github.com/lzyprime/android_demos</span></span><br><span class="line"><span class="comment"># branch: viewBinding</span></span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> -b viewBinding https://github.com/lzyprime/android_demos</span><br></pre></td></tr></table></figure>

<p>最近几个月忙于写需求，积累了太多要总结的东西。当然也正是这几个月的大量实践，对一些知识有了新的认识和发现。</p>
<p><code>ViewBinding</code> <code>DataBinding</code> 通过 <code>xml</code> 声明，生成对应代码，刨开生成的源码看一下，大概就能明白原理。</p>
<p>有用的可能就是 <code>val binding by viewBinding&lt;T&gt;()</code> 的两个拓展函数实现。其余就是如官网文档一样的备忘录内容，方便知识点查找。</p>
<h2 id="ViewBinding"><a href="#ViewBinding" class="headerlink" title="ViewBinding"></a>ViewBinding</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/view-binding">ViewBinding 官网</a></p>
</blockquote>
<h3 id="生成的源码"><a href="#生成的源码" class="headerlink" title="生成的源码"></a>生成的源码</h3><p>ViewBinding 库代替之前的<code>kotlin-android-extensions</code>, 根据布局文件 <code>layout/example.xml</code> 生成对应的<code>[ExampleBinding]</code>.</p>
<p>以<code>[FragmentDetailBinding]</code>为例, 看一下生成的源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentDetailBinding</span> <span class="keyword">implements</span> <span class="title">ViewBinding</span> </span>&#123;</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FrameLayout rootView;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> ImageView imageView;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">FragmentDetailBinding</span><span class="params">(<span class="meta">@NonNull</span> FrameLayout rootView, <span class="meta">@NonNull</span> ImageView imageView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.rootView = rootView;</span><br><span class="line">    <span class="keyword">this</span>.imageView = imageView;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FrameLayout <span class="title">getRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rootView;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FragmentDetailBinding <span class="title">inflate</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> inflate(inflater, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FragmentDetailBinding <span class="title">inflate</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Nullable</span> ViewGroup parent, <span class="keyword">boolean</span> attachToParent)</span> </span>&#123;</span><br><span class="line">    View root = inflater.inflate(R.layout.fragment_detail, parent, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (attachToParent) &#123;</span><br><span class="line">      parent.addView(root);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bind(root);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FragmentDetailBinding <span class="title">bind</span><span class="params">(<span class="meta">@NonNull</span> View rootView)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The body of this method is generated in a way you would not otherwise write.</span></span><br><span class="line">    <span class="comment">// This is done to optimize the compiled bytecode for size and performance.</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    missingId: &#123;</span><br><span class="line">      id = R.id.imageView;</span><br><span class="line">      ImageView imageView = rootView.findViewById(id);</span><br><span class="line">      <span class="keyword">if</span> (imageView == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span> missingId;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> FragmentDetailBinding((FrameLayout) rootView, imageView);</span><br><span class="line">    &#125;</span><br><span class="line">    String missingId = rootView.getResources().getResourceName(id);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;Missing required view with ID: &quot;</span>.concat(missingId));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>基类<code>[ViewBinding]</code>是<code>interface</code>, 只有一个<code>getRoot</code>方法，返回显示的<code>View</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A type which binds the views in a layout XML to fields. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewBinding</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the outermost &#123;<span class="doctag">@link</span> View&#125; in the associated layout file. If this binding is for a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> &lt;merge&gt;&#125; layout, this will return the first view inside of the merge tag.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">View <span class="title">getRoot</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每份生成的代码:</p>
<ul>
<li>根据<code>layout/fragment_detail.xml</code>下划线名称生成对应驼峰类名<code>FragmentDetailBinding</code></li>
<li>根据布局文件中组件<code>id</code>, 生成对应驼峰式成员名，类型为组件类型. 如<code>imageView: ImageView</code></li>
<li>根部局生成为<code>rootView</code></li>
</ul>
<p>构造函数私有，需要的参数为上述根据<code>id</code>生成的成员.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">FragmentDetailBinding</span><span class="params">(<span class="meta">@NonNull</span> FrameLayout rootView, <span class="meta">@NonNull</span> ImageView imageView)</span></span></span><br></pre></td></tr></table></figure>

<p>同时生成3个静态函数作为<code>工厂构造</code></p>
<ul>
<li>两个<code>inflate</code>用传入的 <code>[inflater: LayoutInflater]</code> 获得对应的<code>View</code>. </li>
<li>调用<code>bind</code>，通过<code>findViewById</code>获得各个组件, 然后通过私有构造得到<code>[FragmentDetailBinding]</code></li>
</ul>
<p>也就是说, <code>findViewById</code> 的过程靠生成代码解决，所以在拿到一个<code>ViewBinding</code>实例时, 可以通过成员直接访问。</p>
<p><code>kotlin 伪代码大概写一下工厂构造的调用关系</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">inflate</span><span class="params">(inflater: <span class="type">LayoutInflater</span>)</span></span>: FragmentDetailBinding = inflate(inflater, <span class="literal">null</span>, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">inflate</span><span class="params">(inflater: <span class="type">LayoutInflater</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">            parent: <span class="type">ViewGroup</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">            attachToParent: <span class="type">Boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>: FragmentDetailBinding &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">val</span> root: View = inflater.inflate(...)</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span> bind(root)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">bind</span><span class="params">(rootView: <span class="type">View</span>)</span></span>: FragmentDetailBinding &#123;</span><br><span class="line">    <span class="comment">// findViewById</span></span><br><span class="line">    <span class="keyword">val</span> imageView = rootView.findViewById(R.id.imageView)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FragmentDetailBinding(rootView, imageView)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li>当前没有View, 需要新建</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官网例子：</span></span><br><span class="line"><span class="comment">// Activity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultProfileActivity</span> : <span class="type">AppCompatActivity</span></span>()&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> binding: ResultProfileBinding</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        <span class="comment">// 通过 inflate 新建</span></span><br><span class="line">        binding = ResultProfileBinding.inflate(layoutInflater)</span><br><span class="line">        <span class="keyword">val</span> view = binding.root</span><br><span class="line">        setContentView(view)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fragment</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultProfileFragment</span> : <span class="type">Fragment</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> _binding: ResultProfileBinding? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> binding <span class="keyword">get</span>() = _binding!!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(inflater: <span class="type">LayoutInflater</span>, container: <span class="type">ViewGroup</span>?, savedInstanceState: <span class="type">Bundle</span>?)</span></span>: View? &#123;</span><br><span class="line">        _binding = ResultProfileBinding.inflate(inflater, container, <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">val</span> view = binding.root</span><br><span class="line">        <span class="keyword">return</span> view</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroyView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroyView()</span><br><span class="line">        _binding = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>已有视图，直接通过<code>bind</code>获得</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fragment 构造直接传 R.layout.fragment_detail</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetailFragment</span> : <span class="type">Fragment</span></span>(R.layout.fragment_detail) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> _binding: FragmentDetailBinding? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> binding <span class="keyword">get</span>() = _binding!!</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此时R.layout.fragment_detail对应View已存在，直接 bind</span></span><br><span class="line">        _binding = FragmentDetailBinding.bind(view)</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroyView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroyView()</span><br><span class="line">        _binding = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理其他地方，没有视图调用<code>inflate</code>构造，有视图调用<code>bind</code>直接获得.</p>
<h3 id="Activity-Fragment-使用优化"><a href="#Activity-Fragment-使用优化" class="headerlink" title="Activity, Fragment 使用优化"></a>Activity, Fragment 使用优化</h3><p>存在的问题: </p>
<ul>
<li>过程重复。 每个<code>Activity</code>和<code>Fragment</code>中，流程相同，仅仅是具体<code>[ViewBinding]</code>的区别。</li>
<li><code>Fragment</code>中, <code>onDestroyView</code>时要将<code>_binding</code>置空，对于<code>binding</code>的操作时机靠自己保证，时序自己保证。</li>
<li><code>lateinit var</code> 在代码扫描中视为风险行为，不建议使用(个人项目随意)。</li>
</ul>
<p>仿照</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> model: VM <span class="keyword">by</span> viewModels&lt;VM&gt;()</span><br></pre></td></tr></table></figure>

<p>通过<code>拓展函数, 委托, 反射</code>, 实现类似</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> binding: FragmentDetailBinding <span class="keyword">by</span> viewBinding&lt;FragmentDetailBinding&gt;()</span><br></pre></td></tr></table></figure>


<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于[Activity]生成对应[ViewBinding].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@exception</span> ClassCastException 当 [VB] 无法通过</span></span><br><span class="line"><span class="comment"> * `VB.inflate(LayoutInflater.from(this#Activity))` 构造成功时抛出</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> VB : ViewBinding&gt;</span> Activity.<span class="title">viewBinding</span><span class="params">()</span></span> = <span class="keyword">object</span> : Lazy&lt;VB&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> cached: VB? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> value: VB</span><br><span class="line">        <span class="keyword">get</span>() =</span><br><span class="line">            cached ?: VB::<span class="keyword">class</span>.java.getMethod(</span><br><span class="line">                <span class="string">&quot;inflate&quot;</span>,</span><br><span class="line">                LayoutInflater::<span class="keyword">class</span>.java,</span><br><span class="line">            ).invoke(<span class="literal">null</span>, layoutInflater).let &#123;</span><br><span class="line">                <span class="keyword">if</span> (it <span class="keyword">is</span> VB) &#123;</span><br><span class="line">                    cached = it</span><br><span class="line">                    it</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ClassCastException()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isInitialized</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> = cached != <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> binding <span class="keyword">by</span> viewBinding&lt;ActivityMainBinding&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确保调用该函数设置binding.root</span></span><br><span class="line">        setContentView(binding.root)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Activity</code>内联拓展函数，通过调用<code>inflate(inflater: LayoutInflater)</code>版本生成<code>binding</code>。需要自己确保在<code>onCreate</code>之后使用，否则拿不到<code>Activity.layoutInflater</code>, 构造失败</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于 [Fragment] 内构造对应 [ViewBinding].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@exception</span> ClassCastException 当 [VB] 无法通过 `VB.bind(view)` 构造成功时抛出</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 函数会自动注册[Fragment.onDestroyView]时的注销操作.</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> VB : ViewBinding&gt;</span> Fragment.<span class="title">viewBinding</span><span class="params">()</span></span> = <span class="keyword">object</span> : Lazy&lt;VB&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> cached: VB? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> value: VB</span><br><span class="line">        <span class="keyword">get</span>() = cached ?: VB::<span class="keyword">class</span>.java.getMethod(</span><br><span class="line">            <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">            View::<span class="keyword">class</span>.java,</span><br><span class="line">        ).invoke(VB::<span class="keyword">class</span>.java, <span class="keyword">this</span><span class="symbol">@viewBinding</span>.requireView()).let &#123;</span><br><span class="line">            <span class="keyword">if</span> (it <span class="keyword">is</span> VB) &#123;</span><br><span class="line">                <span class="comment">// 监听Destroy事件</span></span><br><span class="line">                viewLifecycleOwner.lifecycle.addObserver(<span class="keyword">object</span> : LifecycleObserver &#123;</span><br><span class="line">                    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</span></span><br><span class="line">                    <span class="function"><span class="keyword">fun</span> <span class="title">onDestroyView</span><span class="params">()</span></span> &#123;</span><br><span class="line">                        cached = <span class="literal">null</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                cached = it</span><br><span class="line">                it</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> ClassCastException()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isInitialized</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> = cached != <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleFragment</span>:<span class="type">Fragment</span></span>(R.layout.example_fragment) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> binding <span class="keyword">by</span> viewBinding&lt;ExampleFragmentBinding&gt;()</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">        <span class="comment">// 确保在此之后使用binding</span></span><br><span class="line">        binding.xxxTextView.text = <span class="string">&quot;sssss&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Fragment</code>内联拓展函数，通过调用<code>bind(rootView: View)</code>版本生成<code>binding</code>。</p>
<p>前提是调用<code>Fragment(@LayoutRes)</code>版本构造, 利用<code>Fragment</code>默认的<code>onCreateView</code>行为得到<code>View</code>。因此要在<code>onViewCreated</code>后使用<code>binding</code>。否则<code>Fragment.requireView()</code>拿不到view, <code>bind</code>失败。</p>
<p>通过<code>viewLifecycleOwner.lifecycle</code>监听<code>Destroy</code>行为，将<code>cached</code>赋为<code>null</code>, 当重新构建<code>View</code>时，<code>binding</code>的<code>isInitialized() == false</code>, 认为没有初始化，重新走<code>value get()</code>中的逻辑，达到重新绑定的效果。</p>
<hr>
<p>总结：原有问题仍有一部分未解决(如: 自己保证执行时序), 但一定程度上减少了重复代码，尤其是<code>Fragment</code>中。</p>
<h2 id="DataBinding"><a href="#DataBinding" class="headerlink" title="DataBinding"></a>DataBinding</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/data-binding">DataBinding 官网</a></p>
</blockquote>
<p><code>DataBinding</code>相当于<code>ViewBinding++</code></p>
<p>在<code>xml</code>中传递和使用数据</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- layout作为根 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 数据 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.example.User&quot;</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 布局 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:text</span>=<span class="string">&quot;@&#123;user.firstName&#125;&quot;</span>/&gt;</span> <span class="comment">&lt;!-- 使用数据 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:text</span>=<span class="string">&quot;@&#123;user.lastName&#125;&quot;</span>/&gt;</span> <span class="comment">&lt;!-- 使用数据 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// data class User(val firstName: String, val lastName: String)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> binding: ActivityMainBinding = DataBindingUtil.setContentView(</span><br><span class="line">                <span class="keyword">this</span>, R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        binding.user = User(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;User&quot;</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>基类<code>[ViewDataBinding]</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewDataBinding</span> <span class="keyword">extends</span> <span class="title">BaseObservable</span> <span class="keyword">implements</span> <span class="title">ViewBinding</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>实现了<code>[ViewBinding]</code>, 生成的代码中<code>inflate, bind</code>函数签名相同，内部实现略有不同，所以上边<code>by viewBinding&lt;T&gt;()</code>仍然适用。</p>
</li>
<li><p>同时继承<code>[BaseObservable]</code>, 使得本身成为<code>[Observable]</code>, 可观察者</p>
</li>
</ul>
<p>除了像<code>ViewBinding</code>中构造方式, 还可以使用<code>DataBindingUtil</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Activity, 等价于 inflate + setContentView </span></span><br><span class="line"><span class="keyword">val</span> binding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_main)</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">val</span> binding = DataBindingUtil.inflate(layoutInflater, R.layout.list_item, viewGroup, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>

<h3 id="绑定表达式"><a href="#绑定表达式" class="headerlink" title="绑定表达式"></a>绑定表达式</h3><h4 id="lt-data-gt-中"><a href="#lt-data-gt-中" class="headerlink" title="&lt;data&gt; 中"></a><code>&lt;data&gt;</code> 中</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 声明 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.example.User&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 导入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;android.view.View&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 类型别名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;com.example.real.estate.View&quot;</span> <span class="attr">alias</span>=<span class="string">&quot;Vista&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 集合 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;android.util.SparseArray&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;java.util.Map&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;java.util.List&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span> <span class="attr">type</span>=<span class="string">&quot;List<span class="symbol">&amp;lt;</span>String&gt;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;sparse&quot;</span> <span class="attr">type</span>=<span class="string">&quot;SparseArray<span class="symbol">&amp;lt;</span>String&gt;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;map&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Map<span class="symbol">&amp;lt;</span>String, String&gt;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;index&quot;</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;key&quot;</span> <span class="attr">type</span>=<span class="string">&quot;String&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 在布局中使用</span></span><br><span class="line"><span class="comment">        android:text=&quot;@&#123;list[index]&#125;&quot;</span></span><br><span class="line"><span class="comment">        android:text=&quot;@&#123;sparse[index]&#125;&quot;</span></span><br><span class="line"><span class="comment">        android:text=&quot;@&#123;map[key]&#125;&quot; </span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="布局中，表达式"><a href="#布局中，表达式" class="headerlink" title="布局中，表达式"></a>布局中，表达式</h4><ul>
<li>算术运算符 <code>+ - / * %</code></li>
<li>字符串连接运算符 <code>+</code></li>
<li>逻辑运算符 <code>&amp;&amp; ||</code></li>
<li>二元运算符 <code>&amp; | ^</code></li>
<li>一元运算符 <code>+ - ! ~</code></li>
<li>移位运算符 <code>&gt;&gt; &gt;&gt;&gt; &lt;&lt;</code></li>
<li>比较运算符 <code>== &gt; &lt; &gt;= &lt;=</code></li>
<li><code>instanceof</code></li>
<li>分组运算符 <code>()</code></li>
<li>字面量运算符 - 字符、字符串、数字、null</li>
<li>类型转换</li>
<li>方法调用</li>
<li>字段访问</li>
<li>数组访问 <code>[]</code></li>
<li>三元运算符 <code>?:</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 当链式调用中存在可空类型时, 如： --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:text</span>=<span class="string">&quot;@&#123;a.b.c.d.e&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 相当于 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:text</span>=<span class="string">&quot;@&#123;a?.b?.c?.d?.e&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 其中有一环为空, 则表达式值为null --&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:text</span>=<span class="string">&quot;@&#123;expr ?? defautValue&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 相当于 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:text</span>=<span class="string">&quot;@&#123;expr != null ? expr : defautValue&#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 资源引用 --&gt;</span></span><br><span class="line">android:padding=&quot;@&#123;large ? @dimen/largePadding : @dimen/smallPadding&#125;&quot;</span><br><span class="line">android:text=&quot;@&#123;@string/nameFormat(firstName, lastName)&#125;&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- function --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;task&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.android.example.Task&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;presenter&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.android.example.Presenter&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; presenter.onSaveClick(task)&#125;&quot;</span> /&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">class Presenter &#123;</span></span><br><span class="line"><span class="comment">    fun onSaveClick(view: View, task: Task)&#123;&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">android:onClick=&quot;@&#123;(theView) -&gt; presenter.onSaveClick(theView, task)&#125;&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">class Presenter &#123;</span></span><br><span class="line"><span class="comment">    fun onCompletedChanged(task: Task, completed: Boolean)&#123;&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">android:onCheckedChanged=&quot;@&#123;(cb, isChecked) -&gt; presenter.completeChanged(task, isChecked)&#125;&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ?: --&gt;</span></span><br><span class="line">android:onClick=&quot;@&#123;(v) -&gt; v.isVisible() ? doSomething() : void&#125;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="适配器"><a href="#适配器" class="headerlink" title="适配器"></a>适配器</h3><p>现有的 <code>资源引用表达式</code> 满足大多数情况，但也有例外，常见为<code>ImageView</code>中。所以用适配器指定处理方法</p>
<ul>
<li><code>@BindingMethods</code></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将 android:tint 交由 setImageTintList(ColorStateList) 处理, 而非原有 setTint()</span></span><br><span class="line"><span class="meta">@BindingMethods(value = [</span></span><br><span class="line"><span class="meta">    BindingMethod(</span></span><br><span class="line"><span class="meta">        type = android.widget.ImageView::class,</span></span><br><span class="line"><span class="meta">        attribute = <span class="meta-string">&quot;android:tint&quot;</span>,</span></span><br><span class="line"><span class="meta">        method = <span class="meta-string">&quot;setImageTintList&quot;</span>)</span>])</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@BindingAdapter</code></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(value = [<span class="meta-string">&quot;imageUrl&quot;</span>, <span class="meta-string">&quot;placeholder&quot;</span>], requireAll = false)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setImageUrl</span><span class="params">(imageView: <span class="type">ImageView</span>, url: <span class="type">String</span>?, placeHolder: <span class="type">Drawable</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">null</span>) &#123;</span><br><span class="line">        imageView.setImageDrawable(placeholder);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        MyImageLoader.loadInto(imageView, url, placeholder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//xml</span></span><br><span class="line">&lt;ImageView app:imageUrl=<span class="string">&quot;@&#123;venue.imageUrl&#125;&quot;</span> app:error=<span class="string">&quot;@&#123;@drawable/venueError&#125;&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@BindingConversion</code>, 自定义转换</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingConversion</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">convertColorToDrawable</span><span class="params">(color: <span class="type">Int</span>)</span></span> = ColorDrawable(color)</span><br><span class="line"></span><br><span class="line"><span class="comment">//xml</span></span><br><span class="line">&lt;View android:background=<span class="string">&quot;@&#123;isError ? @drawable/error : @color/white&#125;&quot;</span> .../&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@TargetApi</code>, 监听器有多个方法时，需要拆分处理</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// View.OnAttachStateChangeListener 为例</span></span><br><span class="line"><span class="comment">// 有两个方法：onViewAttachedToWindow(View) 和 onViewDetachedFromWindow(View)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 拆分</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.HONEYCOMB_MR1)</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnViewDetachedFromWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onViewDetachedFromWindow</span><span class="params">(v: <span class="type">View</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.HONEYCOMB_MR1)</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnViewAttachedToWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onViewAttachedToWindow</span><span class="params">(v: <span class="type">View</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. BindAdapter</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@BindingAdapter(</span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;android:onViewDetachedFromWindow&quot;</span>,</span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;android:onViewAttachedToWindow&quot;</span>,</span></span><br><span class="line"><span class="meta">        requireAll = false</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setListener</span><span class="params">(view: <span class="type">View</span>, detach: <span class="type">OnViewDetachedFromWindow</span>?, attach:<span class="type">OnViewAttachedToWindow</span>?)</span></span> &#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. xml中使用</span></span><br></pre></td></tr></table></figure>

<h3 id="Observable-LiveData作为数据"><a href="#Observable-LiveData作为数据" class="headerlink" title="Observable, LiveData作为数据"></a><code>Observable</code>, <code>LiveData</code>作为数据</h3><p>数据更新时，UI自动刷新</p>
<ul>
<li><code>ObservableBoolean</code></li>
<li><code>ObservableByte</code></li>
<li><code>ObservableChar</code></li>
<li><code>ObservableShort</code></li>
<li><code>ObservableInt</code></li>
<li><code>ObservableLong</code></li>
<li><code>ObservableFloat</code></li>
<li><code>ObservableDouble</code></li>
<li><code>ObservableParcelable</code></li>
<li><code>ObservableArrayList</code></li>
<li><code>ObservableArrayMap</code></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> : <span class="type">BaseObservable</span></span>() &#123;</span><br><span class="line">    <span class="meta">@get:Bindable</span> <span class="comment">// 给getter方法打标签, BR中会生成对应条目</span></span><br><span class="line">    <span class="keyword">var</span> firstName: String = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = value</span><br><span class="line">            notifyPropertyChanged(BR.firstName) <span class="comment">// 刷新UI</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">@get:Bindable</span></span><br><span class="line">    <span class="keyword">var</span> lastName: String = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = value</span><br><span class="line">            notifyPropertyChanged(BR.lastName) <span class="comment">// 刷新UI</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者用 <code>LiveData</code>, 在代码中需要调用<code>setLifecycleOwner()</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- data class User(val firstName: LiveData&lt;String&gt;, val lastName: LiveData&lt;String&gt;) --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- xml中 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;duration&quot;</span> <span class="attr">type</span>=<span class="string">&quot;LiveData&lt;String&gt;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.example.User&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:text</span>=<span class="string">&quot;@&#123;user.firstName&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:text</span>=<span class="string">&quot;@&#123;duration&#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kotlin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleFragment</span> : <span class="type">Fragment</span></span>(R.layout.example_fragment) &#123;</span><br><span class="line">    ...</span><br><span class="line">    binding.duration = liveData&lt;String&gt; &#123; emitSource(...) &#125;</span><br><span class="line">    binding.user = model.user</span><br><span class="line">    binding.setLifecycleOwner(viewLifecycleOwner)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合两者使用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableViewModel</span> : <span class="type">ViewModel</span></span>(), Observable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callbacks: PropertyChangeRegistry = PropertyChangeRegistry()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加订阅</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">addOnPropertyChangedCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            callback: <span class="type">Observable</span>.<span class="type">OnPropertyChangedCallback</span>)</span></span> &#123;</span><br><span class="line">        callbacks.add(callback)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消订阅</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">removeOnPropertyChangedCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            callback: <span class="type">Observable</span>.<span class="type">OnPropertyChangedCallback</span>)</span></span> &#123;</span><br><span class="line">        callbacks.remove(callback)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 全量刷新</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">notifyChange</span><span class="params">()</span></span> &#123;</span><br><span class="line">        callbacks.notifyCallbacks(<span class="keyword">this</span>, <span class="number">0</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 精确刷新</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">notifyPropertyChanged</span><span class="params">(fieldId: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        callbacks.notifyCallbacks(<span class="keyword">this</span>, fieldId, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据双向绑定"><a href="#数据双向绑定" class="headerlink" title="数据双向绑定 @={}"></a>数据双向绑定 <code>@=&#123;&#125;</code></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">CheckBox</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/rememberMeCheckBox&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:checked</span>=<span class="string">&quot;@=&#123;viewmodel.rememberMe&#125;&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginViewModel</span> : <span class="type">BaseObservable &#123;</span></span></span><br><span class="line">    <span class="comment">// val data = ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bindable</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getRememberMe</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> = <span class="keyword">data</span>.rememberMe</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setRememberMe</span><span class="params">(value: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">data</span>.rememberMe != value) &#123;</span><br><span class="line">            <span class="keyword">data</span>.rememberMe = value</span><br><span class="line"></span><br><span class="line">            <span class="comment">// React to the change.</span></span><br><span class="line">            saveData()</span><br><span class="line"></span><br><span class="line">            notifyPropertyChanged(BR.remember_me)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>@InverseBindingAdapter</code>和<code>@InverseBindingMethod</code>, 自定义双向绑定</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 数据变动时调用的方法</span></span><br><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">&quot;time&quot;</span>)</span></span><br><span class="line"><span class="meta">@JvmStatic</span> <span class="function"><span class="keyword">fun</span> <span class="title">setTime</span><span class="params">(view: <span class="type">MyView</span>, newValue: <span class="type">Time</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Important to break potential infinite loops.</span></span><br><span class="line">    <span class="keyword">if</span> (view.time != newValue) &#123;</span><br><span class="line">        view.time = newValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. view变动时调用的方法</span></span><br><span class="line"><span class="meta">@InverseBindingAdapter(<span class="meta-string">&quot;time&quot;</span>)</span></span><br><span class="line"><span class="meta">@JvmStatic</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTime</span><span class="params">(view: <span class="type">MyView</span>)</span></span> : Time &#123;</span><br><span class="line">    <span class="keyword">return</span> view.getTime()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 变动时机和方式, 后缀`AttrChanged`</span></span><br><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">&quot;app:timeAttrChanged&quot;</span>)</span></span><br><span class="line"><span class="meta">@JvmStatic</span> <span class="function"><span class="keyword">fun</span> <span class="title">setListeners</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        view: <span class="type">MyView</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        attrChange: <span class="type">InverseBindingListener</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 使用 InverseBindingListener 告知数据绑定系统，特性已更改</span></span><br><span class="line">    <span class="comment">// 数据绑定系统调用@InverseBindingAdapter绑定的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// warning: 避免陷入循环刷新.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            </article>
        </div>

        <div class="col"></div>
    </div>
</div>
    <footer class="h-25"> footer </footer>
</body>

</html>